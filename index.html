<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo Check</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #212121);
            color: var(--tg-theme-text-color, #ffffff);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            padding: 20px;
            text-align: center;
            box-sizing: border-box;
        }

        .loader {
            border: 4px solid var(--tg-theme-hint-color, #f3f3f3);
            border-top: 4px solid var(--tg-theme-button-color, #3498db);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #loading, #result { display: none; width: 100%; flex-direction: column; align-items: center; }
        .icon { font-size: 64px; margin-bottom: 15px; }
        h2 { margin: 10px 0; }
        p { color: var(--tg-theme-hint-color, #aaaaaa); margin-bottom: 30px; }

        button {
            background-color: var(--tg-theme-button-color, #3498db);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            max-width: 300px;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }
    </style>
</head>
<body>

    <div id="loading" style="display: flex;">
        <div class="loader"></div>
        <span>Определяем регион...</span>
    </div>

    <div id="result">
        <div class="icon" id="status-icon"></div>
        <h2 id="status-title"></h2>
        <p id="status-desc"></p>
        <button onclick="returnToBot()">Вернуться в бота</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); 

        // !!! ВАЖНО: ВПИШИ СЮДА ЮЗЕРНЕЙМ БОТА (БЕЗ @) !!!
        const botUsername = "animecassettebot"; 
        
        let finalCountry = "UNKNOWN";

        function showResult(isAllowed, countryName, code) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('result').style.display = 'flex';
            
            finalCountry = code;

            if (isAllowed) {
                document.getElementById('status-icon').innerText = "✅";
                document.getElementById('status-title').innerText = "Доступ разрешен";
                document.getElementById('status-desc').innerHTML = `Ваш регион: <b>${countryName}</b><br>Нажмите кнопку ниже, чтобы начать просмотр.`;
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            } else {
                document.getElementById('status-icon').innerText = "⛔️";
                document.getElementById('status-title').innerText = "Доступ ограничен";
                document.getElementById('status-desc').innerHTML = `Ваш регион: <b>${countryName}</b><br>Просмотр недоступен.`;
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            }
        }

        function returnToBot() {
            // Формируем ссылку: t.me/BotName?start=geo_CODE
            // Например: t.me/AnimeBot?start=geo_RU
            const link = `https://t.me/${botUsername}?start=geo_${finalCountry}`;
            
            // Используем нативный метод WebApp для открытия ссылок Telegram
            tg.openTelegramLink(link);
            tg.close(); // Пытаемся закрыть окно WebApp
        }

        fetch('https://ipwho.is/')
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (data.country_code === "RU") {
                        showResult(false, "Россия", "RU");
                    } else {
                        showResult(true, data.country, data.country_code);
                    }
                } else {
                    // Ошибка API -> Разрешаем
                    showResult(true, "Не определен", "UNKNOWN");
                }
            })
            .catch(err => {
                // Ошибка сети -> Разрешаем
                showResult(true, "Ошибка сети", "ERROR");
            });
    </script>
</body>
</html>
